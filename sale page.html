<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Page and Add product to cart</title>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
</head>

<body>

    <div class="container">
        <div class="row mt-4">
            <div class="col-12">


                <div class="row">
                    <div class="col-12">
                        <h2
                            style="color: rgb(121, 62, 98); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: bolder;">
                            Products</h2>

                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="products">
                            <tr>
                                <td>Heighlighter</td>
                                <td>500.00 $</td>
                                <td>
                                    <button type="button" class="btn btn-outline-warning">ADD TO CART</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>





                <div class="row">
                    <div class="col-10">
                        <h2
                            style="color: rgb(121, 62, 98); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: bolder;">
                            Cart</h2>
                    </div>

                    <div class="col-2">
                        <b id="total-price">Total : $0</b>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="cart-Items">
                            <tr>
                                <td>Heighlighter</td>
                                <td>500.00 $</td>
                                <td>1</td>
                                <td>500.00 $</td>
                                <td>
                                    <button class="btn btn-danger">REMOVE FROM CART</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>

    </div>






















    <script>
        function getCurrentUser() {
            var keys = Object.keys(localStorage);
            let userKey;
            let loginUser = localStorage.getItem("loginUser");
            keys.forEach(element => {
                if (element !== "loginUser") {
                    let user = JSON.parse(localStorage.getItem(element));
                    if (user.email == loginUser)
                        userKey = element;
                }
            });
            return userKey;
        }
        function addToCartStorage(productId, quantity, localStorageKey) {
            let user = JSON.parse(localStorage.getItem(localStorageKey));
            if (user.cart == undefined)
                user.cart = [];
                user.cart.push({ productId: productId, quantity: quantity });
                
            localStorage.setItem(localStorageKey, JSON.stringify(user));
        }
        function setQuantity(productId, quantity, localStorageKey) {
            let user = JSON.parse(localStorage.getItem(localStorageKey));
            let product = user.cart.find(a => a.productId === productId);
            product.quantity = quantity; 
            localStorage.setItem(localStorageKey, JSON.stringify(user));
        }

        const products = [
            {
                id: 1,
                name: 'Heightlighter',
                price: 500.00,
            },


            {
                id: 2,
                name: 'Lipstick',
                price: 1000.00,
            },

            {
                id: 3,
                name: 'Primer',
                price: 1000.00,
            },

            {
                id: 4,
                name: 'Spray',
                price: 1000.00,
            },

            {
                id: 5,
                name: 'RedRoj',
                price: 1000.00,
            },
            {
                id: 6,
                name: 'Pronz',
                price: 1000.00,
            },

            {
                id: 7,
                name: 'Green Primer',
                price: 1000.00,
            },

            {
                id: 8,
                name: 'LosePowder',
                price: 800.00,
            },

            {
                id: 9,
                name: 'EyeLinear',
                price: 1000.00,
            },

            {
                id: 10,
                name: 'ColoredPowder',
                price: 280.00,
            },

            {
                id: 11,
                name: 'Cream',
                price: 1000.00,
            },

            {
                id: 12,
                name: 'Perfume',
                price: 1000.00,
            },
        ]






        let cart = {
            items: [],
            totalPrice: 0,
        }

        function renderAllProducts() {
            const productTable = document.getElementById('products');
            productTable.innerHTML = ''
            products.forEach((product, index) => {
                productTable.innerHTML += `
            <tr> 
                <td>${product.name}</d>
                <td>$${product.price}</d>
                    <td>
                     <button type="button" class="btn btn-outline-warning" onclick="addToCart(${index})">ADD TO CART</button>
                    </td>
            </tr>
            `
            })
        }

        function renderAllCartItems() {
            const cartItemTable = document.getElementById('cart-Items');
            const totalPriceElement = document.getElementById('total-price');
            let totalPrice = 0;
            cartItemTable.innerHTML = ''
            if (cart.items.length === 0) {
                cartItemTable.innerHTML = `
            <tr>
                <td colspan="5">There is no item in cart yet....</td>
            </tr>
            `
            }
            cart.items.forEach((cartItem, index) => {
                totalPrice += cartItem.total;
                cartItemTable.innerHTML += `
            <tr> 
                <td>${cartItem.name}</d>
                <td>$${cartItem.price}</d>
                <td>${cartItem.Quantity}</d>
                <td>$${cartItem.total}</d>
                    <td>
                     <button class="btn btn-danger" onclick="removeFromCart('${cartItem.name}')">REMOVE FROM CART</button>
                    </td>
            </tr>
            `
            })

            totalPriceElement.innerText = `Total : $${totalPrice}`
        }

        function addToCart(productIndex) {
            console.log(productIndex)  // this line to test productindex
            const product = products[productIndex]
            let isAlreadyInCart = false;
            let currentUser = getCurrentUser();
            let newCartItems = cart.items.reduce((state, item) => {
                if (item.name === product.name) {
                    isAlreadyInCart = true;
                    const newItem = {
                        ...item,
                        Quantity: item.Quantity + 1,
                        total: (item.Quantity + 1) * item.price
                    }
                    setQuantity(product.id, newItem.Quantity, currentUser);
                    return [...state, newItem];
                }
                return [...state, item]
            }, [])


            if (!isAlreadyInCart) {
                newCartItems.push({
                    ...product,
                    Quantity: 1,
                    total: product.price,
                });
                addToCartStorage(product.id, 1, currentUser);
            } // modifiey card to push the  items in card 
            cart = {
                ...cart,
                items: newCartItems,
            }

            renderAllCartItems();
        }

        function removeFromCart(productName) {
            let product = cart.items.find(a => a.name === productName);
            let currentUser = getCurrentUser();
            if (product.Quantity === 1) {
                // remove  
                // filter return array 
                cart.items = cart.items.filter(function (el) { return el.name != productName; });
            } else {
                product.Quantity -= 1;
                product.price -= 1;
                setQuantity(product.id, product.Quantity, currentUser);

                // descrease quantity by one for every click
            }

            
            //     let isAlreadyInCart=false;
            //    let newCartItems=cart.items.reduce((state,item)=>{
            //         if(item.name===productName){
            //             // isAlreadyInCart=true;
            //             const newItem={
            //                 ...item,
            //                 Quantity:item.Quantity-1,
            //                 total:(item.Quantity-1)*item.price
            //             }
            //             if(newItem.Quantity>0){
            //                 return [...state,item]
            //             }
            //             return state;
            //         }
            //         return[...state,item]
            //     },[])

            // cart={
            //     ...cart,
            //     items:newCartItems,
            // }
            renderAllCartItems();
        }

        renderAllProducts();
        renderAllCartItems();
    </script>
</body>

</html>